import{state as e}from"./constants.js";import{ui as t}from"./uiUtils.js";import{quoteManager as r}from"./quoteManager.js";import{dialoguePreview as o}from"./dialoguePreview.js";import{ResultCache as n,PreviewCache as s}from"./cache.js";let resultCache=new n,previewCache=new s;export const converter={async convertText(){let o=document.getElementById("inputText").value.trim(),n=document.getElementById("narratorName").value||" ";if(!o){t.showStatus("请输入要转换的文本！","error");return}let s=r.getSelectedQuotes(),i={narratorName:n,selectedQuotePairs:s,characterMapping:e.currentConfig,enableLive2D:e.enableLive2D,costumeMapping:e.currentCostumes,positionConfig:{autoPositionMode:positionManager.autoPositionMode,manualPositions:positionManager.manualPositions}},l=resultCache.generateKey(o,i),a=resultCache.get(l);if(a){resultCache.hits=(resultCache.hits||0)+1,console.log("使用缓存结果"),e.currentResult=a,document.getElementById("resultContent").textContent=a,Prism.highlightElement(document.getElementById("resultContent")),document.getElementById("resultSection").style.display="block",t.showStatus("转换完成！(使用缓存)","success"),t.scrollToElement("resultSection");return}resultCache.requests=(resultCache.requests||0)+1;try{t.setButtonLoading("convertBtn",!0,"转换中..."),t.showProgress(10),t.showStatus("正在处理文本...","info");let u=await axios.post("/api/convert",{text:o,narrator_name:n,selected_quote_pairs:s,character_mapping:e.currentConfig,enable_live2d:e.enableLive2D,costume_mapping:e.currentCostumes,position_config:i.positionConfig});t.showProgress(100);let c=u.data.result;resultCache.set(l,c),e.currentResult=c,document.getElementById("resultContent").textContent=c,Prism.highlightElement(document.getElementById("resultContent")),document.getElementById("resultSection").style.display="block",t.showStatus("转换完成！","success"),t.scrollToElement("resultSection"),setTimeout(()=>t.hideProgress(),1e3)}catch(p){t.showStatus(`转换失败: ${p.response?.data?.error||p.message}`,"error"),t.hideProgress()}finally{t.setButtonLoading("convertBtn",!1)}},async updateSplitPreview(n=!1){let s=document.getElementById("splitInputText").value.trim();if(!s){document.querySelector("#splitPreviewJson code").textContent="// 请输入文本以查看预览",document.getElementById("splitPreviewDialogue").innerHTML='<p style="text-align: center; color: #718096;">请输入文本以查看预览</p>';return}let i=document.getElementById("splitNarratorName").value||" ",l=r.getSelectedQuotes(),a={narratorName:i,selectedQuotePairs:l,enableLive2D:e.enableLive2D},u=previewCache.generatePreviewKey(s,a),c=previewCache.get(u);if(c&&!n){e.currentResult=c,document.querySelector("#splitPreviewJson code").textContent=c,Prism.highlightElement(document.querySelector("#splitPreviewJson code")),o.updateDialoguePreview(c,"splitPreviewDialogue");return}n&&t.setButtonLoading("splitConvertBtn",!0,"刷新中...");try{let p=await axios.post("/api/convert",{text:s,narrator_name:i,selected_quote_pairs:l,character_mapping:e.currentConfig,enable_live2d:e.enableLive2D,costume_mapping:e.currentCostumes,position_config:{autoPositionMode:positionManager.autoPositionMode,manualPositions:positionManager.manualPositions}}),g=p.data.result;previewCache.set(u,g),e.currentResult=g,document.querySelector("#splitPreviewJson code").textContent=g,Prism.highlightElement(document.querySelector("#splitPreviewJson code")),o.updateDialoguePreview(g,"splitPreviewDialogue")}catch(m){let d=`转换失败: ${m.response?.data?.error||m.message}`;document.querySelector("#splitPreviewJson code").textContent=`// ${d}`,document.getElementById("splitPreviewDialogue").innerHTML=`<p style="text-align: center; color: #e53e3e;">${d}</p>`}finally{n&&t.setButtonLoading("splitConvertBtn",!1)}}};export{resultCache};