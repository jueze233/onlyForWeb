import{state as e}from"./constants.js";import{ui as t}from"./uiUtils.js";import{quoteManager as o}from"./quoteManager.js";import{dialoguePreview as r}from"./dialoguePreview.js";export const converter={async convertText(){let r=document.getElementById("inputText").value.trim(),n=document.getElementById("narratorName").value||" ";if(!r){t.showStatus("请输入要转换的文本！","error");return}let s=o.getSelectedQuotes();try{t.setButtonLoading("convertBtn",!0,"转换中..."),t.showProgress(10),t.showStatus("正在处理文本...","info");let i=await axios.post("/api/convert",{text:r,narrator_name:n,selected_quote_pairs:s,character_mapping:e.currentConfig,enable_live2d:e.enableLive2D,costume_mapping:e.currentCostumes,position_config:{autoPositionMode:positionManager.autoPositionMode,manualPositions:positionManager.manualPositions}});t.showProgress(100),e.currentResult=i.data.result,document.getElementById("resultContent").textContent=e.currentResult,Prism.highlightElement(document.getElementById("resultContent")),document.getElementById("resultSection").style.display="block",t.showStatus("转换完成！","success"),t.scrollToElement("resultSection"),setTimeout(()=>t.hideProgress(),1e3)}catch(a){t.showStatus(`转换失败: ${a.response?.data?.error||a.message}`,"error"),t.hideProgress()}finally{t.setButtonLoading("convertBtn",!1)}},async updateSplitPreview(n=!1){let s=document.getElementById("splitInputText").value.trim();if(!s){document.querySelector("#splitPreviewJson code").textContent="// 请输入文本以查看预览",document.getElementById("splitPreviewDialogue").innerHTML='<p style="text-align: center; color: #718096;">请输入文本以查看预览</p>';return}let i=document.getElementById("splitNarratorName").value||" ",a=o.getSelectedQuotes();n&&t.setButtonLoading("splitConvertBtn",!0,"刷新中...");try{let l=await axios.post("/api/convert",{text:s,narrator_name:i,selected_quote_pairs:a,character_mapping:e.currentConfig,enable_live2d:e.enableLive2D,costume_mapping:e.currentCostumes,position_config:{autoPositionMode:positionManager.autoPositionMode,manualPositions:positionManager.manualPositions}}),u=l.data.result;e.currentResult=u,document.querySelector("#splitPreviewJson code").textContent=u,Prism.highlightElement(document.querySelector("#splitPreviewJson code")),r.updateDialoguePreview(u,"splitPreviewDialogue")}catch(c){let p=`转换失败: ${c.response?.data?.error||c.message}`;document.querySelector("#splitPreviewJson code").textContent=`// ${p}`,document.getElementById("splitPreviewDialogue").innerHTML=`<p style="text-align: center; color: #e53e3e;">${p}</p>`}finally{n&&t.setButtonLoading("splitConvertBtn",!1)}}};