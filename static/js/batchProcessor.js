import{state as t,FILE_EXTENSIONS as e}from"./constants.js";import{ui as a}from"./uiUtils.js";import{quoteManager as n}from"./quoteManager.js";export const batchProcessor={openBatchModal(){document.getElementById("batchFileInput").value="";let e=document.getElementById("batchFileList");e&&(e.innerHTML="");let n=document.getElementById("batchProgressSection"),s=document.getElementById("batchLogSection"),l=document.getElementById("batchProgressBar"),o=document.getElementById("batchStatusText");n.style.display="none",s.style.display="none",l.style.width="0%",o.textContent="正在处理...",document.getElementById("downloadBatchResultBtn").style.display="none";let r=document.getElementById("startBatchBtn");r.style.display="inline-flex",r.disabled=!0,r.innerHTML="开始批量转换";let c=document.querySelector('#batchConvertModal .btn-secondary[onclick*="batchConvertModal"]');c&&(c.style.display="inline-flex"),t.batchFiles=[],t.batchResults=[],a.openModal("batchConvertModal")},updateBatchFileList(){let a=document.getElementById("batchFileInput"),n=document.getElementById("batchFileList");n.innerHTML="",t.batchFiles=Array.from(a.files),t.batchFiles.length>0?(t.batchFiles.forEach(t=>{let a=document.createElement("li"),s=t.name.endsWith(e.DOCX)?"\uD83D\uDCC4":t.name.endsWith(e.MD)?"\uD83D\uDCDD":"\uD83D\uDCC3";a.textContent=`${s} ${t.name} (${(t.size/1024).toFixed(2)} KB)`,n.appendChild(a)}),document.getElementById("startBatchBtn").disabled=!1):document.getElementById("startBatchBtn").disabled=!0},async startBatchConversion(){if(0===t.batchFiles.length){a.showStatus("请先选择文件！","error");return}let s=document.getElementById("startBatchBtn");s.disabled=!0,s.innerHTML='<div class="loading"></div> 上传并准备中...';try{let l=await Promise.all(t.batchFiles.map(t=>new Promise((a,n)=>{let s=new FileReader,l=t.name.toLowerCase();l.endsWith(e.DOCX)?(s.onload=()=>a({name:t.name,content:s.result,encoding:"base64"}),s.readAsDataURL(t)):(s.onload=()=>a({name:t.name,content:s.result,encoding:"text"}),s.readAsText(t)),s.onerror=n})));s.style.display="none",document.getElementById("batchProgressSection").style.display="block",document.getElementById("batchLogSection").style.display="block",document.getElementById("batchLogOutput").innerHTML="";let o=document.getElementById("narratorName").value||" ",r=n.getSelectedQuotes(),c=await axios.post("/api/batch_convert/start",{files:l,narrator_name:o,selected_quote_pairs:r,character_mapping:t.currentConfig,enable_live2d:t.enableLive2D,costume_mapping:t.currentCostumes}),{task_id:i}=c.data;if(i)this.pollBatchStatus(i);else throw Error("未能从服务器获取任务ID。")}catch(d){a.showStatus(`启动批量处理失败: ${d.response?.data?.error||d.message}`,"error"),s.disabled=!1,s.innerHTML="开始批量转换",s.style.display="inline-flex",document.getElementById("batchProgressSection").style.display="none",document.getElementById("batchLogSection").style.display="none"}},pollBatchStatus(e){let n=setInterval(async()=>{try{let s=await axios.get(`/api/batch_convert/status/${e}`),l=s.data;document.getElementById("batchProgressBar").style.width=`${l.progress}%`,document.getElementById("batchStatusText").textContent=l.status_text;let o=document.getElementById("batchLogOutput");if(o.innerHTML=l.logs.join("<br>"),o.scrollTop=o.scrollHeight,"completed"===l.status){clearInterval(n),t.batchResults=l.results||[],t.batchResults.length>0&&(document.getElementById("downloadBatchResultBtn").style.display="inline-flex");let r=document.querySelector("#batchConvertModal .btn-secondary");r&&(r.style.display="none"),a.showStatus("批量处理完成！","success")}}catch(c){clearInterval(n),document.getElementById("batchStatusText").textContent="轮询状态失败，任务可能已在后台完成或中断。",a.showStatus(`获取处理状态失败: ${c.message}`,"error")}},1500)},handleBatchDownload(){if(0===t.batchResults.length){a.showStatus("没有可下载的批量处理结果！","error");return}let e=new JSZip;t.batchResults.forEach(t=>{e.file(t.name,t.content)}),e.generateAsync({type:"blob"}).then(function(t){let e=`batch_results_${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.zip`;saveAs(t,e),a.showStatus("结果已打包下载！","success")}).catch(t=>{a.showStatus(`打包下载失败: ${t.message}`,"error")})}};