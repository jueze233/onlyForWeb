import{GRADIENTS as e,state as t}from"./constants.js";import{ui as a}from"./uiUtils.js";import{quoteManager as r}from"./quoteManager.js";export const dialoguePreview={getCharacterAvatar:e=>e&&e>0?`/static/images/avatars/${e}.png`:null,getAvatarGradient:t=>e[t%e.length],updateDialoguePreview(e,t){try{let a=JSON.parse(e),r=document.getElementById(t);if(r.innerHTML="",!a.actions||0===a.actions.length){r.innerHTML='<p style="text-align: center; color: #718096;">没有对话内容</p>';return}let n=0;a.actions.forEach(e=>{if("talk"!==e.type)return;let t=!e.name||""===e.name.trim()||" "===e.name;if(t&&(!e.body||""===e.body.trim()))return;let a=document.createElement("div");if(a.className=`dialogue-item ${t?"narrator":""}`,a.style.animationDelay=`${.05*n}s`,!t){let i=e.characters&&e.characters[0]?e.characters[0]:0,l=this.getCharacterAvatar(i),s=document.createElement("div");if(s.className="dialogue-avatar",l&&i>0){let o=document.createElement("img");o.src=l,o.alt=e.name,o.className="avatar-img",s.classList.add("loading"),o.onload=()=>{s.classList.remove("loading")},o.onerror=()=>{s.classList.remove("loading"),s.innerHTML=e.name.charAt(0),s.style.background=this.getAvatarGradient(i),s.classList.add("fallback")},s.appendChild(o)}else s.textContent=e.name.charAt(0),s.style.background=this.getAvatarGradient(i),s.classList.add("fallback");a.appendChild(s)}let c=document.createElement("div");if(c.className="dialogue-content",!t){let d=document.createElement("div");d.className="dialogue-name",d.textContent=e.name,c.appendChild(d)}let m=document.createElement("div");m.className="dialogue-text",m.textContent=e.body,c.appendChild(m),a.appendChild(c),r.appendChild(a),n++}),0===n&&(r.innerHTML='<p style="text-align: center; color: #718096;">没有对话内容</p>')}catch(i){container.innerHTML=`<p style="text-align: center; color: #e53e3e;">预览失败: ${i.message}</p>`}},async showDialoguePreview(){let e=document.getElementById("inputText").value.trim();if(!e){a.showStatus("请先输入要转换的文本！","error");return}await a.withButtonLoading("previewModeBtn",async()=>{let n=document.getElementById("narratorName").value||" ",i=r.getSelectedQuotes();try{let l=await axios.post("/api/convert",{text:e,narrator_name:n,selected_quote_pairs:i,character_mapping:t.currentConfig});this.updateDialoguePreview(l.data.result,"dialogueContainer"),a.openModal("dialoguePreviewModal")}catch(s){a.showStatus(`预览失败: ${s.response?.data?.error||s.message}`,"error")}},"生成预览...")}};