import{state as e}from"./constants.js";import{ui as t}from"./uiUtils.js";import{converter as o}from"./converter.js";export const quoteManager={loadCustomQuotes(){try{let t=localStorage.getItem("bestdori_custom_quotes");if(t)return e.customQuotes=JSON.parse(t),!0}catch(o){console.error("加载自定义引号失败:",o)}return e.customQuotes=[],!1},saveCustomQuotes(){try{return localStorage.setItem("bestdori_custom_quotes",JSON.stringify(e.customQuotes)),!0}catch(t){return console.error("保存自定义引号失败:",t),!1}},renderQuoteOptions(){let t=document.getElementById("quoteOptionsContainer");t.innerHTML="",this.loadCustomQuotes(),e.quotesConfig&&e.quotesConfig.quote_categories&&Object.entries(e.quotesConfig.quote_categories).forEach(([e,o])=>{let s=`quote-check-${e.replace(/\s/g,"-")}`;this.addQuoteOptionToContainer(t,s,e,o[0],o[1],!0)}),e.customQuotes.forEach((e,o)=>{let s=`quote-check-custom-saved-${o}`;this.addQuoteOptionToContainer(t,s,e.name,e.open,e.close,e.checked)})},addQuoteOptionToContainer(e,t,o,s,l,n){let u=document.createElement("div");u.style.display="flex",u.style.alignItems="center",u.style.marginBottom="8px";let c=document.createElement("input");c.type="checkbox",c.id=t,c.dataset.open=s,c.dataset.close=l,c.className="quote-option-checkbox",c.checked=n;let r=document.createElement("label");if(r.htmlFor=t,r.textContent=o,r.style.marginLeft="8px",r.style.cursor="pointer",r.style.flex="1",t.includes("custom")){let a=document.createElement("button");a.className="btn btn-sm",a.style.background="#fee",a.style.color="#e53e3e",a.style.marginLeft="10px",a.style.padding="2px 8px",a.style.fontSize="0.8rem",a.textContent="删除",a.onclick=()=>this.removeCustomQuote(o),u.appendChild(c),u.appendChild(r),u.appendChild(a)}else u.appendChild(c),u.appendChild(r);e.appendChild(u)},removeCustomQuote(s){let l={};document.querySelectorAll(".quote-option-checkbox").forEach(e=>{let t=`${e.dataset.open}_${e.dataset.close}`;l[t]=e.checked}),e.customQuotes=e.customQuotes.filter(e=>e.name!==s),this.saveCustomQuotes(),this.renderQuoteOptions(),document.querySelectorAll(".quote-option-checkbox").forEach(e=>{let t=`${e.dataset.open}_${e.dataset.close}`;t in l&&(e.checked=l[t])});let n=document.getElementById("splitQuoteModal");if(n&&"none"!==n.style.display){let u=document.getElementById("quoteOptionsContainer"),c=document.getElementById("splitQuoteOptionsContainer");c.innerHTML="",u.querySelectorAll(".quote-option-checkbox").forEach((t,s)=>{let l=t.parentElement.cloneNode(!0),n=l.querySelector(".quote-option-checkbox"),u=l.querySelector("label"),r=`split-${n.id}`;n.id=r,u.htmlFor=r,n.checked=t.checked,n.addEventListener("change",()=>{t.checked=n.checked,e.autoPreviewEnabled&&o.updateSplitPreview()});let a=l.querySelector("button");if(a&&"删除"===a.textContent){let i=u.textContent;a.onclick=()=>{this.removeCustomQuote(i)}}c.appendChild(l)})}t.showStatus("自定义引号已删除","success")},getSelectedQuotes(){let t=[];return document.querySelectorAll(".quote-option-checkbox").forEach(o=>{let s=o.dataset.open,l=o.dataset.close;if(o.id.includes("custom-saved")){let n=`${s}...${l}`,u=e.customQuotes.find(e=>e.name===n);u&&(u.checked=o.checked)}o.checked&&s&&l&&t.push([s,l])}),this.saveCustomQuotes(),t},addCustomQuoteOption(){let o=document.getElementById("customQuoteOpen").value,s=document.getElementById("customQuoteClose").value;if(!o||!s){t.showStatus("起始和结束符号都不能为空！","error");return}let l=`${o}...${s}`,n=e.customQuotes.some(e=>e.name===l);if(n){t.showStatus("该引号对已存在！","error");return}let u={};document.querySelectorAll(".quote-option-checkbox").forEach(e=>{let t=`${e.dataset.open}_${e.dataset.close}`;u[t]=e.checked}),e.customQuotes.push({name:l,open:o,close:s,checked:!0}),this.saveCustomQuotes(),this.renderQuoteOptions(),document.querySelectorAll(".quote-option-checkbox").forEach(e=>{let t=`${e.dataset.open}_${e.dataset.close}`;t in u&&(e.checked=u[t])}),document.getElementById("customQuoteOpen").value="",document.getElementById("customQuoteClose").value="",t.showStatus("自定义引号已添加","success")},openSplitQuoteModal(){let s=document.getElementById("quoteOptionsContainer"),l=document.getElementById("splitQuoteOptionsContainer");l.innerHTML="",s.querySelectorAll(".quote-option-checkbox").forEach((t,s)=>{let n=t.parentElement.cloneNode(!0),u=n.querySelector(".quote-option-checkbox"),c=n.querySelector("label"),r=`split-${u.id}`;u.id=r,c.htmlFor=r,u.checked=t.checked,u.addEventListener("change",()=>{t.checked=u.checked,e.autoPreviewEnabled&&o.updateSplitPreview()});let a=n.querySelector("button");if(a&&"删除"===a.textContent){let i=c.textContent;a.onclick=()=>{this.removeCustomQuote(i)}}l.appendChild(n)}),t.openModal("splitQuoteModal")},addSplitCustomQuoteOption(){let s=document.getElementById("splitCustomQuoteOpen").value,l=document.getElementById("splitCustomQuoteClose").value;if(!s||!l){t.showStatus("起始和结束符号都不能为空！","error");return}let n=`${s}...${l}`,u=e.customQuotes.some(e=>e.name===n);if(u){t.showStatus("该引号对已存在！","error");return}let c=document.getElementById("splitQuoteOptionsContainer"),r={};c.querySelectorAll(".quote-option-checkbox").forEach(e=>{let t=`${e.dataset.open}_${e.dataset.close}`;r[t]=e.checked}),e.customQuotes.push({name:n,open:s,close:l,checked:!0}),this.saveCustomQuotes(),this.renderQuoteOptions();let a=document.getElementById("quoteOptionsContainer");a.querySelectorAll(".quote-option-checkbox").forEach(e=>{let t=`${e.dataset.open}_${e.dataset.close}`;t in r&&(e.checked=r[t])}),this.openSplitQuoteModal(),document.getElementById("splitCustomQuoteOpen").value="",document.getElementById("splitCustomQuoteClose").value="",t.showStatus("自定义引号已添加","success"),e.autoPreviewEnabled&&o.updateSplitPreview()}};