import{state as t}from"./constants.js";import{ui as i}from"./uiUtils.js";export const positionManager={positions:["leftInside","center","rightInside"],positionNames:{leftInside:"左侧",center:"中间",rightInside:"右侧"},autoPositionMode:!0,manualPositions:{},positionCounter:0,init(){this.loadPositionConfig();let t=document.getElementById("autoPositionCheckbox");t&&t.addEventListener("change",t=>{this.autoPositionMode=t.target.checked,this.toggleManualConfig()});let i=document.getElementById("savePositionsBtn");i&&i.addEventListener("click",()=>this.savePositions());let o=document.getElementById("resetPositionsBtn");o&&o.addEventListener("click",()=>this.resetPositions())},loadPositionConfig(){let t=localStorage.getItem("bestdori_position_config");if(t)try{let i=JSON.parse(t);this.autoPositionMode=!1!==i.autoPositionMode,this.manualPositions=i.manualPositions||{}}catch(o){console.error("加载位置配置失败:",o)}},savePositionConfig(){let t={autoPositionMode:this.autoPositionMode,manualPositions:this.manualPositions};localStorage.setItem("bestdori_position_config",JSON.stringify(t))},getAvatarId:t=>({229:6,337:1,338:2,339:3,340:4,341:5})[t]||t,openPositionModal(){let t=document.getElementById("autoPositionCheckbox");t&&(t.checked=this.autoPositionMode),this.renderPositionList(),this.toggleManualConfig(),i.openModal("positionModal")},closePositionModal(){i.closeModal("positionModal")},toggleManualConfig(){let t=document.getElementById("manualPositionConfig");t&&(t.style.display=this.autoPositionMode?"none":"block")},renderPositionList(){let i=document.getElementById("positionList");if(!i)return;i.innerHTML="";let o=Object.entries(t.currentConfig).sort(([,t],[,i])=>{let o=t&&t.length>0?t[0]:1/0,s=i&&i.length>0?i[0]:1/0;return o-s});o.forEach(([t,o])=>{if(!o||0===o.length)return;let s=o[0],e=this.getAvatarId(s),n=e>0?`/static/images/avatars/${e}.png`:"",a=this.manualPositions[t]||"center",l=document.createElement("div");l.className="position-config-item",l.innerHTML=`
                <div class="position-character-info">
                    <div class="config-avatar-wrapper"> 
                        <div class="config-avatar" data-id="${s}">
                            ${e>0?`<img src="${n}" alt="${t}" class="config-avatar-img" onerror="this.style.display='none'; this.parentElement.innerHTML='${t.charAt(0)}'; this.parentElement.classList.add('fallback');">`:t.charAt(0)}
                        </div>
                    </div>
                    <span class="position-character-name">${t} (ID: ${s})</span>
                </div>
                <select class="form-input position-select" data-character="${t}">
                    ${this.positions.map(t=>`<option value="${t}" ${t===a?"selected":""}>
                            ${this.positionNames[t]}
                        </option>`).join("")}
                </select>
            `;let r=l.querySelector(".position-select");r.addEventListener("change",t=>{this.manualPositions[t.target.dataset.character]=t.target.value}),i.appendChild(l)})},async savePositions(){await i.withButtonLoading("savePositionsBtn",async()=>{await new Promise(t=>setTimeout(t,300)),this.savePositionConfig(),i.showStatus("位置配置已保存！","success"),this.closePositionModal()},"保存中...")},async resetPositions(){confirm("确定要将所有角色的位置恢复为默认（中间）吗？")&&await i.withButtonLoading("resetPositionsBtn",async()=>{this.autoPositionMode=!0,this.manualPositions={},document.querySelectorAll(".position-select").forEach(t=>{t.value="center"});let t=document.getElementById("autoPositionCheckbox");t&&(t.checked=!0),this.toggleManualConfig(),await new Promise(t=>setTimeout(t,300)),this.savePositionConfig(),i.showStatus("已恢复默认位置配置！","success")},"重置中...")},getCharacterPosition(t,i){return this.autoPositionMode?this.positions[i%this.positions.length]:this.manualPositions[t]||"center"},resetPositionCounter(){this.positionCounter=0}};window.positionManager=positionManager;